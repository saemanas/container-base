name: CI

on:
  push:
    branches-ignore:
      - main
      - develop
  pull_request:

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "22.21.1"
  GHCR_IMAGE_PREFIX: ghcr.io/${{ github.repository }}
  ARTIFACT_RETENTION_DAYS: "90"
  ACT_SKIP_ARTIFACTS: ""

jobs:
  check_backend:
    name: check (backend)
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip wheels
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('src/apps/**/requirements.txt', 'tests/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install Python tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff pytest

      - name: Install service dependencies
        run: |
          set -euo pipefail
          for service in api ocr; do
            req="src/apps/${service}/requirements.txt"
            if [ -f "$req" ]; then
              python -m pip install -r "$req"
            fi
          done
          python -m pip install -r tests/requirements.txt 2>/dev/null || true

      - name: Run Ruff checks
        run: |
          set -euo pipefail
          mkdir -p artifacts/ci/ruff
          for service in api ocr; do
            log="artifacts/ci/ruff/${service}.log"
            ruff check "src/apps/${service}" 2>&1 | tee "$log"
          done

      - name: Upload Ruff artifacts
        if: always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1'
        uses: actions/upload-artifact@v4
        with:
          name: ci-ruff-${{ github.run_id }}
          path: artifacts/ci/ruff
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Run PDPA consent regression suite
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/pdpa
          pytest tests/backend/test_pdpa_compliance.py --maxfail=1 --disable-warnings -q 2>&1 | tee artifacts/ci/pdpa/api.log

      - name: Upload PDPA artifacts
        if: always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1'
        uses: actions/upload-artifact@v4
        with:
          name: ci-pdpa-${{ github.run_id }}
          path: artifacts/ci/pdpa/api.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Run Python test suites
        run: |
          set -euo pipefail
          mkdir -p artifacts/ci/pytest
          for service in api ocr; do
            log="artifacts/ci/pytest/${service}.log"
            pytest tests --maxfail=1 --disable-warnings -q 2>&1 | tee "$log"
          done

      - name: Upload Pytest artifacts
        if: always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1'
        uses: actions/upload-artifact@v4
        with:
          name: ci-pytest-${{ github.run_id }}
          path: artifacts/ci/pytest
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  check_portal:
    name: check (portal)
    runs-on: ubuntu-latest
    env:
      PORTAL_DIR: src/apps/portal
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js for portal
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.PORTAL_DIR }}/package-lock.json

      - name: Restore Next.js build cache
        uses: actions/cache@v4
        with:
          path: ${{ env.PORTAL_DIR }}/.next/cache
          key: ${{ runner.os }}-next-cache-${{ hashFiles('package-lock.json') }}

      - name: Install workspace dependencies
        run: npm ci --workspaces --include=dev

      - name: Install portal dependencies
        working-directory: ${{ env.PORTAL_DIR }}
        run: npm ci --include=dev

      - name: Run ESLint
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/eslint
          npm run lint --prefix ${{ env.PORTAL_DIR }} 2>&1 | tee artifacts/ci/eslint/portal.log

      - name: Upload ESLint artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-eslint-portal-${{ github.run_id }}
          path: artifacts/ci/eslint/portal.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Verify portal stack baseline
        run: python3 scripts/check-portal-stack.py

      - name: Run portal tests
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/portal_tests
          npm run test --prefix ${{ env.PORTAL_DIR }} 2>&1 | tee artifacts/ci/portal_tests/portal.log

      - name: Upload portal test artifacts
        if: ${{ always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-portal-tests-${{ github.run_id }}
          path: artifacts/ci/portal_tests/portal.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  check_openapi:
    name: check (openapi)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install OpenAPI tooling
        run: npm install --include=dev

      - name: Lint OpenAPI contract
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/openapi_lint
          npx --yes @redocly/cli@2.11.0 lint specs/001-lowcost-cicd-infra/contracts/openapi.yaml 2>&1 | tee artifacts/ci/openapi_lint/lint.log

      - name: Diff OpenAPI contract against base
        run: |
          set -euo pipefail
          mkdir -p artifacts/ci/openapi_lint
          SPEC_PATH="specs/001-lowcost-cicd-infra/contracts/openapi.yaml"
          BASE_REF=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
          else
            BASE_REF="${{ github.sha }}^"
          fi

          if git rev-parse --verify "$BASE_REF" >/dev/null 2>&1; then
            git show "$BASE_REF:$SPEC_PATH" > artifacts/ci/openapi_lint/base-openapi.yaml || {
              echo "Base spec not found; skipping diff" >&2
              exit 0
            }
            cp "$SPEC_PATH" artifacts/ci/openapi_lint/head-openapi.yaml
            docker run --rm \
              -v "$PWD/artifacts/ci/openapi_lint:/data" \
              tufin/oasdiff:latest diff \
              --fail-on-diff \
              /data/base-openapi.yaml \
              /data/head-openapi.yaml 2>&1 | tee artifacts/ci/openapi_lint/diff.log
          else
            echo "Unable to resolve base ref $BASE_REF; skipping diff" | tee artifacts/ci/openapi_lint/diff.log
          fi

      - name: Upload OpenAPI artifacts
        if: ${{ always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-openapi-${{ github.run_id }}
          path: |
            artifacts/ci/openapi_lint/lint.log
            artifacts/ci/openapi_lint/diff.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build:
    runs-on: ubuntu-latest
    needs:
      - check_backend
      - check_portal
      - check_openapi
    strategy:
      matrix:
        service:
          - { name: "api", path: "src/apps/api" }
          - { name: "ocr", path: "src/apps/ocr" }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service.name }} image
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/build
          docker build "${{ matrix.service.path }}" \
            --tag "${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}:ci-${{ github.run_id }}" 2>&1 | tee artifacts/ci/build/${{ matrix.service.name }}.log

      - name: Upload build artifacts
        if: ${{ always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-build-${{ matrix.service.name }}-${{ github.run_id }}
          path: artifacts/ci/build/${{ matrix.service.name }}.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  ghcr:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        service:
          - { name: "api", path: "src/apps/api" }
          - { name: "ocr", path: "src/apps/ocr" }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.PROJECT_TOKEN }}

      - name: Build and push ${{ matrix.service.name }} image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.path }}
          push: true
          tags: |
            ${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}:ci-${{ github.run_id }}
            ${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}:latest
          cache-from: type=gha,scope=${{ matrix.service.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service.name }}

      - name: Record GHCR summary
        if: always()
        env:
          STAGE_STATUS: ${{ job.status }}
        run: |
          mkdir -p artifacts/ci/ghcr
          cat <<EOF > artifacts/ci/ghcr/${{ matrix.service.name }}.json
          {"stage":"ghcr","service":"${{ matrix.service.name }}","image":"${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}","status":"${STAGE_STATUS}","run_id":"${{ github.run_id }}"}
          EOF

      - name: Upload GHCR artifacts
        if: ${{ always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-ghcr-${{ matrix.service.name }}-${{ github.run_id }}
          path: artifacts/ci/ghcr/${{ matrix.service.name }}.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  tag_deploy:
    name: tag deploy
    runs-on: ubuntu-latest
    needs: ghcr
    steps:
      - name: Summarize pipeline completion
        run: |
          mkdir -p artifacts/ci/tag_deploy
          {
            echo "CI pipeline completed Ruff → ESLint → Pytest → OpenAPI Lint → Build → GHCR → Tag Deploy"
            echo "Run ID: ${{ github.run_id }}"
            echo "Commit: ${{ github.sha }}"
            echo "Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          } > artifacts/ci/tag_deploy/pipeline-summary.txt

      - name: Upload CI pipeline evidence
        if: ${{ env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-tag-deploy-${{ github.run_id }}
          path: artifacts/ci/tag_deploy/pipeline-summary.txt
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
