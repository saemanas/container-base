name: CI

on:
  push:
    branches-ignore:
      - main
      - develop
  pull_request:

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "22.21.1"
  GHCR_IMAGE_PREFIX: ghcr.io/${{ github.repository }}
  ARTIFACT_RETENTION_DAYS: "90"

jobs:
  ruff:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ["api", "ocr-worker"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip wheels
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('src/apps/**/requirements.txt', 'tests/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install Ruff
        run: python -m pip install --upgrade pip ruff

      - name: Run Ruff against ${{ matrix.service }}
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/ruff
          ruff check src/apps/${{ matrix.service }} 2>&1 | tee artifacts/ci/ruff/${{ matrix.service }}.log

      - name: Upload Ruff artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-ruff-${{ matrix.service }}-${{ github.run_id }}
          path: artifacts/ci/ruff/${{ matrix.service }}.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  eslint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: ["portal"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Restore Next.js build cache
        if: ${{ matrix.app == 'portal' }}
        uses: actions/cache@v4
        with:
          path: src/apps/${{ matrix.app }}/.next/cache
          key: ${{ runner.os }}-next-cache-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies (if package.json present)
        run: |
          if [ -f "src/apps/${{ matrix.app }}/package.json" ]; then
            cd src/apps/${{ matrix.app }}
            npm install
          else
            echo "No package.json in src/apps/${{ matrix.app }}; skipping install"
          fi

      - name: Run ESLint (if package.json present)
        run: |
          set -o pipefail
          artifact_dir="artifacts/ci/eslint"
          mkdir -p "${artifact_dir}"
          artifact_file="${artifact_dir}/${{ matrix.app }}.log"
          if [ -f "src/apps/${{ matrix.app }}/package.json" ]; then
            cd src/apps/${{ matrix.app }}
            npm run lint -- --max-warnings=0 2>&1 | tee "../../../${artifact_file}"
          else
            echo "No package.json in src/apps/${{ matrix.app }}; skipping lint" | tee "${artifact_file}"
          fi

      - name: Upload ESLint artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-eslint-${{ matrix.app }}-${{ github.run_id }}
          path: artifacts/ci/eslint/${{ matrix.app }}.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Verify portal stack baseline
        run: python3 scripts/check-portal-stack.py

      - name: Prime portal build cache (if package.json present)
        run: |
          if [ -f "src/apps/${{ matrix.app }}/package.json" ]; then
            cd src/apps/${{ matrix.app }}
            npm run build --if-present || echo "No build script defined"
          else
            echo "No package.json in src/apps/${{ matrix.app }}; skipping build cache prime"
          fi

  pytest:
    runs-on: ubuntu-latest
    needs:
      - ruff
      - eslint
    strategy:
      matrix:
        service: ["api", "ocr-worker"]
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip wheels
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('src/apps/**/requirements.txt', 'tests/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip pytest
          if [ -f "src/apps/${{ matrix.service }}/requirements.txt" ]; then
            python -m pip install -r src/apps/${{ matrix.service }}/requirements.txt
          fi
          pip install -r tests/requirements.txt 2>/dev/null || true

      - name: Run PDPA consent regression suite
        if: ${{ matrix.service == 'api' }}
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/pdpa
          pytest tests/backend/test_pdpa_compliance.py --maxfail=1 --disable-warnings -q 2>&1 | tee artifacts/ci/pdpa/${{ matrix.service }}.log

      - name: Upload PDPA artifacts
        if: ${{ always() && matrix.service == 'api' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-pdpa-${{ github.run_id }}
          path: artifacts/ci/pdpa/${{ matrix.service }}.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Run pytest for ${{ matrix.service }}
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/pytest
          pytest tests --maxfail=1 --disable-warnings -q 2>&1 | tee artifacts/ci/pytest/${{ matrix.service }}.log

      - name: Upload Pytest artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-pytest-${{ matrix.service }}-${{ github.run_id }}
          path: artifacts/ci/pytest/${{ matrix.service }}.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  openapi_lint:
    runs-on: ubuntu-latest
    needs: pytest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Redocly CLI
        run: npm install --global @redocly/cli

      - name: Lint OpenAPI contract
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/openapi_lint
          redocly lint specs/001-lowcost-cicd-infra/contracts/openapi.yaml 2>&1 | tee artifacts/ci/openapi_lint/lint.log

      - name: Upload OpenAPI lint artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-openapi-${{ github.run_id }}
          path: artifacts/ci/openapi_lint/lint.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build:
    runs-on: ubuntu-latest
    needs: openapi_lint
    strategy:
      matrix:
        service:
          - { name: "api", path: "src/apps/api" }
          - { name: "ocr", path: "src/apps/ocr-worker" }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service.name }} image
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/build
          docker build "${{ matrix.service.path }}" \
            --tag "${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}:ci-${{ github.run_id }}" 2>&1 | tee artifacts/ci/build/${{ matrix.service.name }}.log

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-build-${{ matrix.service.name }}-${{ github.run_id }}
          path: artifacts/ci/build/${{ matrix.service.name }}.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  ghcr:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        service:
          - { name: "api", path: "src/apps/api" }
          - { name: "ocr", path: "src/apps/ocr-worker" }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.PROJECT_TOKEN }}

      - name: Build and push ${{ matrix.service.name }} image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.path }}
          push: true
          tags: |
            ${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}:ci-${{ github.run_id }}
            ${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}:latest
          cache-from: type=gha,scope=${{ matrix.service.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service.name }}

      - name: Record GHCR summary
        if: always()
        env:
          STAGE_STATUS: ${{ job.status }}
        run: |
          mkdir -p artifacts/ci/ghcr
          cat <<EOF > artifacts/ci/ghcr/${{ matrix.service.name }}.json
          {"stage":"ghcr","service":"${{ matrix.service.name }}","image":"${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}","status":"${STAGE_STATUS}","run_id":"${{ github.run_id }}"}
          EOF

      - name: Upload GHCR artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-ghcr-${{ matrix.service.name }}-${{ github.run_id }}
          path: artifacts/ci/ghcr/${{ matrix.service.name }}.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  tag_deploy:
    runs-on: ubuntu-latest
    needs: ghcr
    steps:
      - name: Summarize pipeline completion
        run: |
          mkdir -p artifacts/ci/tag_deploy
          {
            echo "CI pipeline completed Ruff → ESLint → Pytest → OpenAPI Lint → Build → GHCR → Tag Deploy"
            echo "Run ID: ${{ github.run_id }}"
            echo "Commit: ${{ github.sha }}"
            echo "Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          } > artifacts/ci/tag_deploy/pipeline-summary.txt

      - name: Upload CI pipeline evidence
        uses: actions/upload-artifact@v4
        with:
          name: ci-tag-deploy-${{ github.run_id }}
          path: artifacts/ci/tag_deploy/pipeline-summary.txt
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
