name: CI

on:
  push:
    branches-ignore:
      - main
      - develop
  pull_request:

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "22.21.1"
  GHCR_IMAGE_PREFIX: ghcr.io/${{ github.repository }}
  ARTIFACT_RETENTION_DAYS: "90"
  ACT_SKIP_ARTIFACTS: ""

jobs:
  checks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - check: python
            setup_python: true
            script: |
              set -euo pipefail
              mkdir -p artifacts/ci/python/ruff artifacts/ci/python/pdpa artifacts/ci/python/pytest
              python -m pip install --upgrade pip
              python -m pip install ruff pytest
              for service in api ocr-worker; do
                req="src/apps/${service}/requirements.txt"
                if [ -f "$req" ]; then
                  python -m pip install -r "$req"
                fi
              done
              python -m pip install -r tests/requirements.txt 2>/dev/null || true

              for service in api ocr-worker; do
                log="artifacts/ci/python/ruff/${service}.log"
                ruff check "src/apps/${service}" 2>&1 | tee "$log"
              done

              pytest tests/backend/test_pdpa_compliance.py --maxfail=1 --disable-warnings -q 2>&1 | tee artifacts/ci/python/pdpa/api.log

              for service in api ocr-worker; do
                log="artifacts/ci/python/pytest/${service}.log"
                pytest tests --maxfail=1 --disable-warnings -q 2>&1 | tee "$log"
              done
            artifact_path: artifacts/ci/python
          - check: portal
            setup_node: true
            script: |
              set -euo pipefail
              npm ci --workspaces --include=dev
              npm ci --include=dev --prefix "$PORTAL_DIR"
              mkdir -p artifacts/ci/portal/eslint artifacts/ci/portal/tests
              npm run lint --prefix "$PORTAL_DIR" 2>&1 | tee artifacts/ci/portal/eslint/portal.log
              python3 scripts/check-portal-stack.py
              npm run test --prefix "$PORTAL_DIR" 2>&1 | tee artifacts/ci/portal/tests/portal.log
            artifact_path: artifacts/ci/portal
          - check: openapi
            setup_node: true
            script: |
              set -euo pipefail
              mkdir -p artifacts/ci/openapi/lint
              npm install --include=dev
              npx --yes @redocly/cli@2.11.0 lint "$SPEC_PATH" 2>&1 | tee artifacts/ci/openapi/lint/lint.log

              BASE_REF=""
              if [ "${{ github.event_name }}" = "pull_request" ]; then
                BASE_REF="origin/${{ github.base_ref }}"
              else
                BASE_REF="${{ github.sha }}^"
              fi

              if git rev-parse --verify "$BASE_REF" >/dev/null 2>&1; then
                git show "$BASE_REF:$SPEC_PATH" > artifacts/ci/openapi/lint/base-openapi.yaml || {
                  echo "Base spec not found; skipping diff" >&2
                  exit 0
                }
                cp "$SPEC_PATH" artifacts/ci/openapi/lint/head-openapi.yaml
                docker run --rm \
                  -v "$PWD/artifacts/ci/openapi/lint:/data" \
                  tufin/oasdiff:latest diff \
                  --fail-on-diff \
                  /data/base-openapi.yaml \
                  /data/head-openapi.yaml 2>&1 | tee artifacts/ci/openapi/lint/diff.log
              else
                echo "Unable to resolve base ref $BASE_REF; skipping diff" | tee artifacts/ci/openapi/lint/diff.log
              fi
            artifact_path: artifacts/ci/openapi
    env:
      PYTHONPATH: ${{ github.workspace }}
      PORTAL_DIR: src/apps/portal
      SPEC_PATH: specs/001-lowcost-cicd-infra/contracts/openapi.yaml
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        if: matrix.setup_python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip wheels
        if: matrix.setup_python == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('src/apps/**/requirements.txt', 'tests/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Set up Node.js
        if: matrix.setup_node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ matrix.check == 'portal' && format('{0}/package-lock.json', env.PORTAL_DIR) || 'package-lock.json' }}

      - name: Restore Next.js build cache
        if: matrix.check == 'portal'
        uses: actions/cache@v4
        with:
          path: ${{ env.PORTAL_DIR }}/.next/cache
          key: ${{ runner.os }}-next-cache-${{ hashFiles('package-lock.json') }}

      - name: Run ${{ matrix.check }} checks
        shell: bash
        run: |
          ${{ matrix.script }}

      - name: Upload ${{ matrix.check }} artifacts
        if: always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1'
        uses: actions/upload-artifact@v4
        with:
          name: ci-${{ matrix.check }}-${{ github.run_id }}
          path: ${{ matrix.artifact_path }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build:
    runs-on: ubuntu-latest
    needs: checks
    strategy:
      matrix:
        service:
          - { name: "api", path: "src/apps/api" }
          - { name: "ocr", path: "src/apps/ocr-worker" }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service.name }} image
        run: |
          set -o pipefail
          mkdir -p artifacts/ci/build
          docker build "${{ matrix.service.path }}" \
            --tag "${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}:ci-${{ github.run_id }}" 2>&1 | tee artifacts/ci/build/${{ matrix.service.name }}.log

      - name: Upload build artifacts
        if: ${{ always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-build-${{ matrix.service.name }}-${{ github.run_id }}
          path: artifacts/ci/build/${{ matrix.service.name }}.log
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  ghcr:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        service:
          - { name: "api", path: "src/apps/api" }
          - { name: "ocr", path: "src/apps/ocr-worker" }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.PROJECT_TOKEN }}

      - name: Build and push ${{ matrix.service.name }} image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.path }}
          push: true
          tags: |
            ${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}:ci-${{ github.run_id }}
            ${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}:latest
          cache-from: type=gha,scope=${{ matrix.service.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service.name }}

      - name: Record GHCR summary
        if: always()
        env:
          STAGE_STATUS: ${{ job.status }}
        run: |
          mkdir -p artifacts/ci/ghcr
          cat <<EOF > artifacts/ci/ghcr/${{ matrix.service.name }}.json
          {"stage":"ghcr","service":"${{ matrix.service.name }}","image":"${{ env.GHCR_IMAGE_PREFIX }}/${{ matrix.service.name }}","status":"${STAGE_STATUS}","run_id":"${{ github.run_id }}"}
          EOF

      - name: Upload GHCR artifacts
        if: ${{ always() && env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-ghcr-${{ matrix.service.name }}-${{ github.run_id }}
          path: artifacts/ci/ghcr/${{ matrix.service.name }}.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  tag_deploy:
    runs-on: ubuntu-latest
    needs: ghcr
    steps:
      - name: Summarize pipeline completion
        run: |
          mkdir -p artifacts/ci/tag_deploy
          {
            echo "CI pipeline completed Ruff → ESLint → Pytest → OpenAPI Lint → Build → GHCR → Tag Deploy"
            echo "Run ID: ${{ github.run_id }}"
            echo "Commit: ${{ github.sha }}"
            echo "Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          } > artifacts/ci/tag_deploy/pipeline-summary.txt

      - name: Upload CI pipeline evidence
        if: ${{ env.ACT_SKIP_ARTIFACTS != 'true' && env.ACT_SKIP_ARTIFACTS != '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-tag-deploy-${{ github.run_id }}
          path: artifacts/ci/tag_deploy/pipeline-summary.txt
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
